name: Deploy Snowflake View

env:
  SCHEMA_PRD: PRD

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  dev:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snow CLI
        run: |
          pip install snowflake-cli-labs

      - name: Configure Snow CLI connection
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
        run: |
          snow connection add \
            --connection-name dev \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PASSWORD" \
            --database POC \
            --schema DEV
          snow connection set-default dev

      - name: Run changed SQL scripts on DEV
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
        run: |
          set -e
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
          else
            MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
          fi
          if [ -z "$MODIFIED_FILES" ]; then
            echo "No .sql files changed."
            exit 0
          fi
          # Sort files by layer: bronze → silver → gold, tasks last
          ORDERED_FILES=$(echo "$MODIFIED_FILES" | while read file; do
            if [[ "$file" == *"/tasks/"* ]]; then
              echo "4:$file"
            elif [[ "$file" == *"/bronze/"* ]]; then
              echo "1:$file"
            elif [[ "$file" == *"/silver/"* ]]; then
              echo "2:$file"
            elif [[ "$file" == *"/gold/"* ]]; then
              echo "3:$file"
            else
              echo "0:$file"
            fi
          done | sort -t: -k1,1n | cut -d: -f2-)
          for file in $ORDERED_FILES; do
            echo "Running $file on schema DEV"
            OUTPUT=$(snow sql -f "$file" -c dev)
            echo "$OUTPUT"
            if [[ "$file" == sql/procedures/* ]]; then
              PROC_NAME=$(echo "$OUTPUT" | grep -oP 'Function \K[^ ]+' | head -1)
              if [[ -n "$PROC_NAME" ]]; then
                echo "Calling procedure $PROC_NAME on schema DEV"
                snow sql -q "CALL $PROC_NAME();" -c dev
              else
                echo "Could not extract the procedure name from the output for file $file"
              fi
            fi
          done

  qa:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    needs: dev
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snow CLI
        run: |
          pip install snowflake-cli-labs

      - name: Configure Snow CLI connection
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
        run: |
          snow connection add \
            --connection-name qa \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PASSWORD" \
            --database POC \
            --schema QA
          snow connection set-default qa

      - name: Run changed SQL scripts on QA
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
        run: |
          set -e
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
          else
            MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
          fi
          if [ -z "$MODIFIED_FILES" ]; then
            echo "No .sql files changed."
            exit 0
          fi
          # Sort files by layer: bronze → silver → gold, tasks last
          ORDERED_FILES=$(echo "$MODIFIED_FILES" | while read file; do
            if [[ "$file" == *"/tasks/"* ]]; then
              echo "4:$file"
            elif [[ "$file" == *"/bronze/"* ]]; then
              echo "1:$file"
            elif [[ "$file" == *"/silver/"* ]]; then
              echo "2:$file"
            elif [[ "$file" == *"/gold/"* ]]; then
              echo "3:$file"
            else
              echo "0:$file"
            fi
          done | sort -t: -k1,1n | cut -d: -f2-)
          for file in $ORDERED_FILES; do
            echo "Running $file on schema QA"
            OUTPUT=$(snow sql -f "$file" -c qa)
            echo "$OUTPUT"
            if [[ "$file" == sql/procedures/* ]]; then
              PROC_NAME=$(echo "$OUTPUT" | grep -oP 'Function \K[^ ]+' | head -1)
              if [[ -n "$PROC_NAME" ]]; then
                echo "Calling procedure $PROC_NAME on schema QA"
                snow sql -q "CALL $PROC_NAME();" -c qa
              else
                echo "Could not extract the procedure name from the output for file $file"
              fi
            fi
          done

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snow CLI
        run: |
          pip install snowflake-cli-labs

      - name: Configure Snow CLI connection
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
        run: |
          snow connection add \
            --connection-name prod \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PASSWORD" \
            --database POC \
            --schema ${{ env.SCHEMA_PRD }}
          snow connection set-default prod

      - name: Run changed SQL scripts on PRD
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
        run: |
          set -e
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
          else
            MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
          fi
          if [ -z "$MODIFIED_FILES" ]; then
            echo "No .sql files changed."
            exit 0
          fi
          # Sort files by layer: bronze → silver → gold, tasks last
          ORDERED_FILES=$(echo "$MODIFIED_FILES" | while read file; do
            if [[ "$file" == *"/tasks/"* ]]; then
              echo "4:$file"
            elif [[ "$file" == *"/bronze/"* ]]; then
              echo "1:$file"
            elif [[ "$file" == *"/silver/"* ]]; then
              echo "2:$file"
            elif [[ "$file" == *"/gold/"* ]]; then
              echo "3:$file"
            else
              echo "0:$file"
            fi
          done | sort -t: -k1,1n | cut -d: -f2-)
          for file in $ORDERED_FILES; do
            echo "Running $file on schema ${{ env.SCHEMA_PRD }}"
            OUTPUT=$(snow sql -f "$file" -c prod)
            echo "$OUTPUT"
            if [[ "$file" == sql/procedures/* ]]; then
              PROC_NAME=$(echo "$OUTPUT" | grep -oP 'Function \K[^ ]+' | head -1)
              if [[ -n "$PROC_NAME" ]]; then
                echo "Calling procedure $PROC_NAME on schema ${{ env.SCHEMA_PRD }}"
                snow sql -q "CALL $PROC_NAME();" -c prod
              else
                echo "Could not extract the procedure name from the output for file $file"
              fi
            fi
          done